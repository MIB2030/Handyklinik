import{s as m,j as e}from"./index-DzINA5TK.js";import{r}from"./react-vendor-CyQtAcHN.js";import{G as p,f as b,m as N,P as R,S as W,X as B}from"./icons-D7vnYvoJ.js";import"./supabase-BIynZPkb.js";function K(){const[f,w]=r.useState([]),[j,v]=r.useState([]),[l,k]=r.useState({total:0,active:0,redeemed:0,printed:0,totalValue:0,redeemedValue:0}),[S,E]=r.useState(!0),[i,G]=r.useState(""),[d,V]=r.useState("all"),[c,x]=r.useState(null),[y,n]=r.useState(""),[C,o]=r.useState(!1);r.useEffect(()=>{h()},[]),r.useEffect(()=>{_()},[f,i,d]);const h=async()=>{try{const{data:t,error:s}=await m.from("vouchers").select("*").order("generated_at",{ascending:!1});if(s)throw s;w(t||[]),A(t||[])}catch(t){console.error("Error fetching vouchers:",t)}finally{E(!1)}},A=t=>{const s={total:t.length,active:t.filter(a=>a.status==="active").length,redeemed:t.filter(a=>a.status==="redeemed").length,printed:t.filter(a=>a.printed_at!==null).length,totalValue:t.reduce((a,g)=>a+g.amount,0),redeemedValue:t.filter(a=>a.status==="redeemed").reduce((a,g)=>a+g.amount,0)};k(s)},_=()=>{let t=[...f];i&&(t=t.filter(s=>s.code.toLowerCase().includes(i.toLowerCase()))),d!=="all"&&(t=t.filter(s=>s.status===d)),v(t)},M=async t=>{var s;try{const{error:a}=await m.from("vouchers").update({status:"redeemed",redeemed_at:new Date().toISOString(),redeemed_by:(s=(await m.auth.getUser()).data.user)==null?void 0:s.id,notes:y||t.notes}).eq("id",t.id);if(a)throw a;await h(),o(!1),x(null),n(""),alert("Gutschein erfolgreich eingelöst!")}catch(a){console.error("Error redeeming voucher:",a),alert("Fehler beim Einlösen des Gutscheins")}},D=async t=>{if(confirm("Möchten Sie diesen Gutschein wirklich als abgelaufen markieren?"))try{const{error:s}=await m.from("vouchers").update({status:"expired"}).eq("id",t.id);if(s)throw s;await h()}catch(s){console.error("Error marking voucher as expired:",s),alert("Fehler beim Aktualisieren des Gutscheins")}},z=t=>{x(t),n(t.notes||""),o(!0)},u=t=>t?new Date(t).toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}):"-",F=t=>{const s={active:"bg-green-100 text-green-800",redeemed:"bg-blue-100 text-blue-800",expired:"bg-gray-100 text-gray-800"},a={active:"Aktiv",redeemed:"Eingelöst",expired:"Abgelaufen"};return e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-semibold ${s[t]}`,children:a[t]})};return S?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"text-gray-600",children:"Lade Gutscheine..."})}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Gutschein-Verwaltung"})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"bg-white rounded-lg shadow p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Gesamt erstellt"}),e.jsx("p",{className:"text-3xl font-bold text-gray-900",children:l.total})]}),e.jsx(p,{className:"w-12 h-12 text-blue-600"})]})}),e.jsx("div",{className:"bg-white rounded-lg shadow p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Aktive Gutscheine"}),e.jsx("p",{className:"text-3xl font-bold text-green-600",children:l.active})]}),e.jsx(b,{className:"w-12 h-12 text-green-600"})]})}),e.jsx("div",{className:"bg-white rounded-lg shadow p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Eingelöst"}),e.jsx("p",{className:"text-3xl font-bold text-blue-600",children:l.redeemed})]}),e.jsx(N,{className:"w-12 h-12 text-blue-600"})]})}),e.jsx("div",{className:"bg-white rounded-lg shadow p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Gedruckt"}),e.jsx("p",{className:"text-3xl font-bold text-yellow-600",children:l.printed})]}),e.jsx(R,{className:"w-12 h-12 text-yellow-600"})]})}),e.jsx("div",{className:"bg-white rounded-lg shadow p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Gesamt-Wert"}),e.jsxs("p",{className:"text-3xl font-bold text-gray-900",children:[l.totalValue,"€"]})]}),e.jsx(p,{className:"w-12 h-12 text-gray-400"})]})}),e.jsx("div",{className:"bg-white rounded-lg shadow p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Eingelöster Wert"}),e.jsxs("p",{className:"text-3xl font-bold text-red-600",children:[l.redeemedValue,"€"]})]}),e.jsx(N,{className:"w-12 h-12 text-red-600"})]})})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow",children:[e.jsx("div",{className:"p-6 border-b border-gray-200",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(W,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"text",placeholder:"Gutschein-Code suchen...",value:i,onChange:t=>G(t.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("select",{value:d,onChange:t=>V(t.target.value),className:"px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[e.jsx("option",{value:"all",children:"Alle Status"}),e.jsx("option",{value:"active",children:"Aktiv"}),e.jsx("option",{value:"redeemed",children:"Eingelöst"}),e.jsx("option",{value:"expired",children:"Abgelaufen"})]})]})}),e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Code"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Wert"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Status"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Erstellt am"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Gedruckt"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Eingelöst am"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Aktionen"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:j.map(t=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[e.jsx("div",{className:"font-mono text-sm font-bold text-gray-900",children:t.code}),t.notes&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:t.notes})]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"text-sm font-semibold text-gray-900",children:[t.amount,"€"]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:F(t.status)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:u(t.generated_at)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:t.printed_at?e.jsxs("div",{children:[e.jsx("div",{children:u(t.printed_at)}),e.jsxs("div",{className:"text-xs text-gray-500",children:["(",t.print_count,"x)"]})]}):e.jsx("span",{className:"text-gray-400",children:"Nicht gedruckt"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:u(t.redeemed_at)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm",children:t.status==="active"&&e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{onClick:()=>z(t),className:"text-blue-600 hover:text-blue-900 font-medium",children:"Einlösen"}),e.jsx("button",{onClick:()=>D(t),className:"text-gray-600 hover:text-gray-900 font-medium",children:"Ablaufen"})]})})]},t.id))})]}),j.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(p,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500",children:"Keine Gutscheine gefunden"})]})]})]}),C&&c&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-lg max-w-md w-full p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900",children:"Gutschein einlösen"}),e.jsx("button",{onClick:()=>{o(!1),x(null),n("")},className:"text-gray-400 hover:text-gray-600",children:e.jsx(B,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsx("div",{className:"text-sm text-gray-600 mb-1",children:"Gutschein-Code:"}),e.jsx("div",{className:"font-mono text-lg font-bold text-gray-900",children:c.code})]}),e.jsxs("div",{className:"bg-blue-50 rounded-lg p-4",children:[e.jsx("div",{className:"text-sm text-gray-600 mb-1",children:"Wert:"}),e.jsxs("div",{className:"text-2xl font-bold text-blue-600",children:[c.amount,"€"]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Notizen (optional)"}),e.jsx("textarea",{value:y,onChange:t=>n(t.target.value),placeholder:"z.B. Rechnung XYZ, Kunde ABC...",rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsxs("button",{onClick:()=>M(c),className:"flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center space-x-2",children:[e.jsx(b,{className:"w-5 h-5"}),e.jsx("span",{children:"Jetzt einlösen"})]}),e.jsx("button",{onClick:()=>{o(!1),x(null),n("")},className:"px-4 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors",children:"Abbrechen"})]})]})]})})]})}export{K as default};
